{% extends 'dashboard_app/base.html' %}
{% block title %}Dashboard - BorrowingHub{% endblock %}
{% block nav_browse_active %}active{% endblock %}
{% block content %}
{% load static %}

                <div class="dashboard-page-header">
                    <div>
                        <h1 class="page-title">Browse Items</h1>
                        <p class="page-subtitle">Find and Borrow items</p>
                    </div>
                    <div class="page-actions">
                        <button id="openRequestsModal" class="dashboard-btn outline">View Requests <span class="request-count">{{ pending_requests_count }}</span></button>
                    </div>
                </div>

                {% if messages %}
                <div class="dashboard-messages">
                    {% for message in messages %}
                        <div class="dashboard-alert dashboard-alert-{{ message.tags }}">{{ message }}</div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Stats Section -->
                <div class="dashboard-stats-row">
                    <div class="dashboard-stat-card red">
                        <i class="fa-solid fa-box-archive"></i>
                        <div>
                            <div class="stat-number">{{ total_items }}</div>
                            <div class="stat-label">Total Items</div>
                        </div>
                    </div>
                    <div class="dashboard-stat-card green">
                        <i class="fa-solid fa-circle-check"></i>
                        <div>
                            <div class="stat-number">{{ available_items }}</div>
                            <div class="stat-label">Available</div>
                        </div>
                    </div>
                    <div class="dashboard-stat-card yellow">
                        <i class="fa-solid fa-hand-holding"></i>
                        <div>
                            <div class="stat-number">{{ borrowed_items }}</div>
                            <div class="stat-label">Borrowed</div>
                        </div>
                    </div>
                    <div class="dashboard-stat-card red">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        <div>
                            <div class="stat-number">{{ overdue_items }}</div>
                            <div class="stat-label">Overdue</div>
                        </div>
                    </div>
                </div>

                <!-- Filter Form -->
                <form method="get" class="dashboard-filter-row">
                    <div class="filter-main-controls">
                        <select name="category" onchange="this.form.submit()">
                            <option {% if category_filter == 'All Categories' or not category_filter %}selected{% endif %}>All Categories</option>
                            <option {% if category_filter == 'Books' %}selected{% endif %}>Books</option>
                            <option {% if category_filter == 'Electronics' %}selected{% endif %}>Electronics</option>
                            <option {% if category_filter == 'Tools' %}selected{% endif %}>Tools</option>
                            <option {% if category_filter == 'Sports' %}selected{% endif %}>Sports</option>
                            <option {% if category_filter == 'School Supplies' %}selected{% endif %}>School Supplies</option>
                            <option {% if category_filter == 'Board Games' %}selected{% endif %}>Board Games</option>
                            <option {% if category_filter == 'Sports Equipment' %}selected{% endif %}>Sports Equipment</option>
                            <option {% if category_filter == 'Toys & Games' %}selected{% endif %}>Toys & Games</option>
                            <option {% if category_filter == 'Furniture' %}selected{% endif %}>Furniture</option>
                            <option {% if category_filter == 'Kitchen Appliances' %}selected{% endif %}>Kitchen Appliances</option>
                            <option {% if category_filter == 'Cleaning Equipment' %}selected{% endif %}>Cleaning Equipment</option>
                            <option {% if category_filter == 'Miscellaneous / Others' %}selected{% endif %}>Miscellaneous / Others</option>
                        </select>
                        <select name="status" onchange="this.form.submit()">
                            <option {% if status_filter == 'All Status' or not status_filter %}selected{% endif %}>All Status</option>
                            <option {% if status_filter == 'Available' %}selected{% endif %}>Available</option>
                            <option {% if status_filter == 'Borrowed' %}selected{% endif %}>Borrowed</option>
                        </select>
                    </div>
                </form>
                
{# Requests modal will show pending requests; do not display inline on dashboard #}

<!-- Requests Modal -->
<div id="requestsModal" class="modal requests-modal" aria-hidden="true" style="display:none;">
    <div class="modal-inner">
        <header class="modal-header">
            <div class="modal-header-content">
                <h3>Pending Requests</h3>
                <span class="pending-badge">{{ pending_requests_count }}</span>
            </div>
            <button id="closeRequestsModal" class="modal-close">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </header>
        <div class="modal-body">
            {% if borrow_requests and borrow_requests|length > 0 %}
                <div class="requests-list">
                    {% for br in borrow_requests %}
                        <div class="request-card">
                            <div class="request-card-left">
                                {% if br.item.image_url %}
                                    <img src="{{ br.item.image_url }}" alt="{{ br.item.name }}" class="request-item-image">
                                {% else %}
                                    <div class="request-item-placeholder">
                                        <i class="fa-solid fa-box"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="request-card-body">
                                <div class="request-item-header">
                                    <h4 class="request-item-name">{{ br.item.name }}</h4>
                                    <span class="request-category-badge">{{ br.item.category }}</span>
                                </div>
                                <div class="request-info">
                                    <div class="request-info-item">
                                        <i class="fa-solid fa-user"></i>
                                        <span>Requested by: <strong>{{ br.borrower.username }}</strong></span>
                                    </div>
                                    <div class="request-info-item">
                                        <i class="fa-solid fa-calendar"></i>
                                        <span>Due: <strong>{{ br.due_date }}</strong></span>
                                    </div>
                                </div>
                            </div>
                            <div class="request-card-actions">
                                <button class="request-action-btn approve approve-request" data-request-id="{{ br.id }}" data-url="{% url 'request_app:approve_borrow_request_ajax' br.id %}">
                                    <i class="fa-solid fa-check"></i>
                                    Approve
                                </button>
                                <button class="request-action-btn reject reject-request" data-request-id="{{ br.id }}" data-url="{% url 'request_app:reject_borrow_request_ajax' br.id %}">
                                    <i class="fa-solid fa-xmark"></i>
                                    Reject
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-requests">
                    <i class="fa-solid fa-inbox"></i>
                    <p>No pending requests at the moment</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>


                <!-- Items List -->
                {% if items %}
                <div class="item-list">
                    {% for item in items %}
                    <div class="item-card">
                        <div class="item-card-image-wrapper">
                            {% if item.image_url %}
                                <img src="{{ item.image_url }}" alt="{{ item.name }}">
                            {% else %}
                                <div class="item-placeholder">No Image</div>
                            {% endif %}
                            <span class="item-status-pill {% if item.is_available %}status-available{% else %}status-borrowed{% endif %}">
                                {% if item.is_available %}Available{% else %}Borrowed{% endif %}
                            </span>
                        </div>
                        <div class="item-card-body">
                            <div class="item-card-meta">
                                <span class="item-category-pill">{{ item.category }}</span>
                            </div>
                            <h4 class="item-title">{{ item.name }}</h4>
                            <p class="item-owner"><strong>Owner:</strong> {{ item.owner.username }}</p>
                            <p class="item-desc">{{ item.description|truncatechars:100 }}</p>
                            <div class="item-card-footer">
                                <div class="item-card-footer-left">
                                    <span class="item-status-label">
                                        <strong>Status:</strong>
                                        {% if item.is_available %}
                                        <span class="available">Available</span>
                                        {% else %}
                                        <span class="borrowed">Borrowed</span>
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="item-card-footer-right">
                                    <a href="{% url 'item_app:item_detail' item.id %}" class="dashboard-btn outline small" style="font-size: 0.8rem;">
                                        <i class="fa-solid fa-eye"></i> View Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if page_obj.paginator.num_pages > 1 %}
                <div class="pagination-container">
                    <div class="pagination-info">
                        Showing {{ page_obj.start_index }} - {{ page_obj.end_index }} of {{ page_obj.paginator.count }} items
                    </div>
                    <div class="pagination">
                        {% if page_obj.has_previous %}
                            <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="pagination-btn">First</a>
                            <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="pagination-btn">Previous</a>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <span class="pagination-btn active">{{ num }}</span>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="pagination-btn">{{ num }}</a>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="pagination-btn">Next</a>
                            <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="pagination-btn">Last</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% else %}
                <div class="dashboard-empty-state">
                    <div class="empty-icon"><i class="fa-solid fa-box-archive"></i></div>
                    <h3>No items yet</h3>
                    <p>Start by adding your first item to track.</p>
                    <a href="{% url 'additem_app:add_item' %}" class="dashboard-action-btn">Add Your First Item</a>
                </div>
                {% endif %}
{% endblock %}

{% block extra_js %}
    <script src="{% static 'dashboard_app/js/requests.js' %}"></script>
{% endblock %}
